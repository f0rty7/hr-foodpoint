import{f as g}from"./chunk-UOSHT3SP.js";import{Ob as o,Q as l,Qb as h,U as u,ha as i,oc as a}from"./chunk-6RWDGMY6.js";var c=class n{constructor(r){this.router=r}API_BASE_URL=a.apiUrl;shouldVerifyUser=i(!0);isLoadingSignal=i(!1);errorSignal=i(null);userResource=h({loader:async({abortSignal:r})=>{let t=localStorage.getItem("auth_token");if(!t||!this.shouldVerifyUser())return null;try{a.enableLogging&&console.log("Verifying token with Resource API...");let e=await fetch(`${this.API_BASE_URL}auth/me`,{signal:r,headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});if(!e.ok)throw e.status===401?(localStorage.removeItem("auth_token"),this.shouldVerifyUser.set(!1),new Error("Authentication token expired or invalid")):new Error(`Authentication verification failed: ${e.status}`);let s=await e.json();return a.enableLogging&&console.log("Token verification successful, user data:",s),{id:s.user.id,name:s.user.name,email:s.user.email,phone:s.user.phone}}catch(e){throw e instanceof Error&&e.name==="AbortError"||(console.warn("Token verification failed:",e),localStorage.removeItem("auth_token"),this.shouldVerifyUser.set(!1)),e}}});currentUser=o(()=>this.userResource.value());isAuthenticated=o(()=>!!this.currentUser());isLoading=o(()=>this.userResource.isLoading()||this.isLoadingSignal());error=o(()=>this.userResource.error()||this.errorSignal());async signin(r){this.isLoadingSignal.set(!0),this.errorSignal.set(null);try{let t=await fetch(`${this.API_BASE_URL}auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:r.email,password:r.password})}),e=await t.json();return t.ok?(localStorage.setItem("auth_token",e.accessToken),this.shouldVerifyUser.set(!0),this.userResource.reload(),this.router.navigate(["/home"]),!0):(this.errorSignal.set(e.message||"Login failed"),!1)}catch{return this.errorSignal.set("Network error. Please try again."),!1}finally{this.isLoadingSignal.set(!1)}}async signup(r){this.isLoadingSignal.set(!0),this.errorSignal.set(null);try{let t=await fetch(`${this.API_BASE_URL}auth/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}),e=await t.json();return t.ok?(localStorage.setItem("auth_token",e.accessToken),this.shouldVerifyUser.set(!0),this.userResource.reload(),this.router.navigate(["/home"]),!0):(this.errorSignal.set(e.message||"Registration failed"),!1)}catch{return this.errorSignal.set("Network error. Please try again."),!1}finally{this.isLoadingSignal.set(!1)}}async signout(){try{let r=this.getAuthToken();r&&await fetch(`${this.API_BASE_URL}auth/logout`,{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}})}catch(r){console.warn("Logout API call failed:",r)}finally{localStorage.removeItem("auth_token"),this.shouldVerifyUser.set(!1),this.router.navigate(["/auth/signin"])}}clearError(){this.errorSignal.set(null)}getAuthToken(){return localStorage.getItem("auth_token")}refreshUser(){this.shouldVerifyUser.set(!0),this.userResource.reload()}get hasError(){return!!(this.userResource.error()||this.errorSignal())}get isUserLoading(){return this.userResource.isLoading()}static \u0275fac=function(t){return new(t||n)(u(g))};static \u0275prov=l({token:n,factory:n.\u0275fac,providedIn:"root"})};export{c as a};
